<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Title</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <th:block th:replace="~{/fragments/headFragment}"></th:block>
</head>
<body>
    <th:block th:replace="~{/fragments/bodyFragment::header}"></th:block>
    <th:block th:replace="~{/fragments/bodyFragment::sidebar}"></th:block>
    <!-- ======= main ======= -->
    <main id="main" class="main">
        <div class="pagetitle">
            <h1>발주상세보기</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">메인</a></li>
                    <li class="breadcrumb-item">구매발주</li>
                    <li class="breadcrumb-item">발주서</li>
                    <li class="breadcrumb-item active">발주상세보기</li>
                </ol>
            </nav>
        </div><!-- End Page Title -->

        <section class="section dashboard">
            <div class="row">
                <!--★★★★★★★★★★카드내용★★★★★★★★★★★★-->
                <div class="col-lg-6">

                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">거래처정보</h5>
                            <!-- General Form Elements -->
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">상호</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="purchaserName" disabled>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">담당자</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="purchaserManager" disabled>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">전화</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="purchaserManagerTel" disabled>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">팩스</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="purchaserManagerFax" disabled>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">이메일</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="purchaserManagerEmail" disabled>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <div class="col-lg-6">

                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">자사정보</h5>
                            <!-- General Form Elements -->
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">상호</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="ourCompanyName" disabled>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">담당자</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control"  disabled>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">전화</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control"  disabled>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">팩스</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control"  disabled>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">이메일</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control"  disabled>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
                <div class="col-lg-12">
                    <form action="orderinsert" method="post">
                        <div class="card">
                            <div class="card-body">
                                <form>
                                    <h5 class="card-title">거래내용</span></h5>
                                    <div class="row mb-3">
                                        <label for="inputText" class="col-sm-2 col-form-label">발주일자</label>
                                        <div class="col-sm-10">
                                            <input type="date" class="form-control" id="purchaseOrderDate">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <label for="inputText" class="col-sm-2 col-form-label" >납기일자</label>
                                        <div class="col-sm-10">
                                            <input type="date" class="form-control" id="procurementPlanDeadLine" disabled>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <label for="inputText" class="col-sm-2 col-form-label">납품장소</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="ourCompanyrAddress" disabled>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <label for="inputText" class="col-sm-2 col-form-label">품목명</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="materialName" disabled>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <label for="inputText" class="col-sm-2 col-form-label">규격/재질</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="materialStandTexture" disabled>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <label for="inputText" class="col-sm-2 col-form-label">수량</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="procurementPlanQuantity" disabled>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <label for="inputText" class="col-sm-2 col-form-label">비고</label>
                                        <div class="col-sm-10">
                                            <textarea class="form-control" style="height: 100px" id="purchaseOrderMemo"></textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <span id="content">
                                        <button type="button" class="btn btn-primary" id="addInspectionPlanResisterBtn">검수계획추가</button>
                                        <button type="button" class="btn btn-primary" id="orderAndDownload">발주처리 및 다운로드 </button>
                                        </span>
                                        <a th:href="purchaseOrderList"><button type="button" class="btn btn-primary">리스트</button></a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </form>
                </div>
                <!--여기에 카드랑 내용 넣어주시면 됩니다-->
            </div> <!--End row-->
        </section>
    </main>
    <!-- End #main -->
    <!--이하 정보 불러오는 JS-->
    <script th:inline="javascript">
        $(document).ready(function (e) {
            function getOurCompany(){
                var ourCompanyCode = "PCC-1";
                console.log("우리회사코드는",ourCompanyCode);
                $.getJSON("/purchasercontent/" + ourCompanyCode, function(data) {
                    var ourCompanyName=data.purchaserName;
                    console.log("우리회사이름은",ourCompanyName);
                    var ourCompanyrAddress=data.purchaserAddress;
                    $('#ourCompanyName').val(ourCompanyName);
                    $('#ourCompanyrAddress').val(ourCompanyrAddress);
                }).fail(function(jqxhr, textStatus, error) {
                    var err = textStatus + ", " + error;
                    console.log("자사정보 요청 실패: " + err);
                });
            }

            var purchaseOrderCode = [[${purchaseOrderCode}]];

            function getPurchaseOrderContent() {
                $.getJSON("/purchaseordercontent/" + purchaseOrderCode, function(data) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const formattedDate = `${year}-${month}-${day}`;

                    console.log("응답데이터", data);
                    $('#purchaserName').val(data.purchaserName);
                    $('#purchaserManager').val(data.purchaserManager);
                    $('#purchaserManagerTel').val(data.purchaserManagerTel);
                    $('#purchaserManagerFax').val(data.purchaserManagerFax);
                    $('#purchaserManagerEmail').val(data.purchaserManagerEmail);

                    $('#purchaseOrderDate').val(formattedDate)
                    $('#procurementPlanDeadLine').val(data.procurementPlanDeadLine.substring(0,10));
                    $('#materialName').val(data.materialName);
                    $('#materialStandTexture').val(data.materialStand+' / '+data.materialTexture);
                    $('#procurementPlanQuantity').val(data.procurementPlanQuantity);
                    $('#purchaseOrderMemo').val(data.purchaseOrderMemo);
                    var purchaseOrderStatus =data.purchaseOrderStatus;

                    if (purchaseOrderStatus !== "PENDING") {
                        $('#purchaseOrderDate').val(data.purchaseOrderDate.substring(0,10));
                        $("#purchaseOrderDate").prop("disabled", true);
                        $("#purchaseOrderMemo").prop("disabled", true);
                        $('#ourCompanyrAddress').prop("disabled", true);
                        console.log("검수계획개수",data.inspectionPlanCount)
                        if ( data.inspectionPlanCount === 0) {
                            console.log("검수계획개수없음")
                            $('#content').html(`
                            <hr>
                            <h5 class="card-title">
                              검수계획 : 미등록
                              <a href="inspectionPlanGet?purchaseOrderCode=`+purchaseOrderCode+`"><button type="button" class="btn btn-primary btn-sm" id="addHtmlBtn">검수계획추가</button></a>
                            </h5>
                            <button type="button" class="btn btn-primary" id="orderModify">발주수정</button>
                            <button type="button" class="btn btn-primary">발주서보기</button>
                            `);
                        }else{
                            console.log("검수계획 있을떄! 이건 나중에 작업")
                            $('#content').html(`
                            <hr>
                            <h5 class="card-title">
                              검수계획 : `+data.inspectionPlanCount+`개
                              <a href="inspectionPlanGet?purchaseOrderCode=`+purchaseOrderCode+`"><button type="button" class="btn btn-primary btn-sm" id="addHtmlBtn">검수계획보기</button></a>
                            </h5>
                            <button type="button" class="btn btn-primary" id="orderModify">발주수정</button>
                            <button type="button" class="btn btn-primary">발주서보기</button>
                            `);
                        }
                    }
                }).fail(function(jqxhr, textStatus, error) {
                    var err = textStatus + ", " + error;
                    console.log("발주 정보 요청 실패: " + err);
                });
            }
            // 함수 호출
            getPurchaseOrderContent();
            getOurCompany();
        });
    </script>
    <!--이상 정보 불러오는 JS-->
    <!--이하 검수처리 계획 등록 화면에 뜨게 하는 JS-->
    <script th:inline="javascript">
        document.getElementById('addInspectionPlanResisterBtn').addEventListener('click', function () {
            var contentDiv = document.getElementById('content');
            var newHtml = `
              <hr>
                        <h5 class="card-title">검수계획</h5>
                        <div class="row mb-3">
                          <label for="inputText" class="col-sm-2 col-form-label" >날짜</label>
                          <div class="col-sm-10">
                            <input type="date" class="form-control" id="inspectionPlanDate">
                          </div>
                        </div>
                        <div class="row mb-3">
                          <label for="inputTime" class="col-sm-2 col-form-label" >시간</label>
                          <div class="col-sm-10">
                            <input type="time" class="form-control" id="inspectionPlanTime">
                          </div>
                        </div>
                        <div class="row mb-3">
                          <label for="inputText" class="col-sm-2 col-form-label">담당자</label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control" >
                          </div>
                        </div>
                        <div class="row mb-3">
                          <label for="inputText" class="col-sm-2 col-form-label">연락처</label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control" >
                          </div>
                        </div>
                        <div class="row mb-3">
                          <label for="inputText" class="col-sm-2 col-form-label">비고</label>
                          <div class="col-sm-10">
                            <textarea class="form-control" style="height: 100px" id="inspectionPlanMemo"></textarea>
                          </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="orderInspectionPlanSaveAndDownload">발주/검수계획저장처리 및 다운로드</button>
              `;
            contentDiv.innerHTML = newHtml;
        });
    </script>
    <!--이상 검수처리 계획 등록 화면에 뜨게 하는 JS-->
    <!--이하 발주처리 및 다운로드 JS-->
    <script th:inline="javascript">
        var purchaseOrderCode = [[${purchaseOrderCode}]];
        $('#orderAndDownload').click(orderSave);

        $(document).on('click', '#orderInspectionPlanSaveAndDownload', function () {
            console.log("발주검수저장"); // 함수가 호출되는지 확인
            var InspectionPlanDTO = {
                purchaseOrderDTO : {purchaseOrderCode: purchaseOrderCode},
                inspectionPlanCode : 'I'+purchaseOrderCode,
                inspectionPlanDateTime: $('#inspectionPlanDate').val() + 'T'+$('#inspectionPlanTime').val(),
                inspectionPlanMemo: $('#inspectionPlanMemo').val()
            };
            console.log("수집한데이터", InspectionPlanDTO);
            $.ajax({
                url: '/purchaseordercontent/inspectionPlan/' + purchaseOrderCode,
                type: "POST",
                data: JSON.stringify(InspectionPlanDTO),
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                success: function(result) {
                    console.log("결과값result: " + result);
                    self.location.reload();
                }
            });
            orderSave();
        });

        // 동적으로 생성된 #orderModify 버튼에 클릭 이벤트 바인딩
        $(document).on('click', '#orderModify', function () {
            console.log("수정 버튼 클릭됨"); // 함수가 호출되는지 확인
            $('#purchaseOrderMemo').prop("disabled", false);
            $('#purchaseOrderDate').prop("disabled", false); // 메모 입력란을 활성화
            $("#orderModify").text('발주수정완료'); // 버튼의 텍스트를 변경
            // ID를 #orderModify에서 #orderAndDownload로 변경
            $("#orderModify").attr('id', 'orderSave');
            // ID 변경 후, 새로운 ID에 대한 이벤트 리스너를 다시 바인딩
            $('#orderSave').click(orderSave);
        });
        function orderSave() {
            var purchaserDTO = {
                purchaseOrderCode: purchaseOrderCode,
                purchaseOrderDate: $('#purchaseOrderDate').val() + 'T00:00:00',
                purchaseOrderMemo: $('#purchaseOrderMemo').val(),
                purchaseOrderStatus: "COMPLETED"
            };
            console.log("수집한데이터", purchaserDTO);
            $.ajax({
                url: '/purchaseordercontent/' + purchaseOrderCode,
                type: "POST",
                data: JSON.stringify(purchaserDTO),
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                success: function(result) {
                    console.log("결과값result: " + result);
                    self.location.reload();
                }
            });
        };
    </script>
    <!--이상 발주처리 및 다운로드 JS-->

    <th:block th:replace="~{/fragments/bodyFragment::footer}"></th:block>
    <th:block th:replace="~{/fragments/bodyFragment::js}"></th:block>
</body>
</html>