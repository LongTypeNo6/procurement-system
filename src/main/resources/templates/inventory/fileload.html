<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload</title>
</head>
<body>
<h1>파일 업로드</h1>
<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="files" multiple><br>
    <button type="button" onclick="uploadFile()">업로드</button><br>
</form>
<h2>파일 목록</h2>
<ul id="fileList"></ul>

<script>
    function uploadFile() {
        const files = document.querySelector('input[type="file"]').files;

        Array.from(files).reduce((promiseChain, file) => {
            return promiseChain.then(() => {
                return checkFileExists(file.name).then(exists => {
                    if (exists) {
                        return confirm(`File ${file.name} already exists. Do you want to overwrite?`);
                    }
                    return true;
                }).then(overwrite => {
                    if (overwrite) {
                        const formData = new FormData();
                        formData.append('files', file);
                        formData.append('overwrite', true);
                        return proceedUpload(formData);
                    }
                });
            });
        }, Promise.resolve()).then(() => {
            alert('All files processed.');
            loadFileList();  // 모든 파일 처리가 완료된 후 파일 목록을 다시 로드
        }).catch(error => {
            console.error('Error:', error);
        });
    }

    function checkFileExists(fileName) {
        return fetch(`/api/files/check?fileName=${fileName}`, {
            method: 'POST',
        })
            .then(response => response.json());
    }

    function proceedUpload(formData) {
        return fetch('/api/files/upload', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(message => alert(message))
            .catch(error => console.error('Error:', error));
    }




    function loadFileList() {
        fetch('/api/files/list')
            .then(response => response.json())
            .then(files => {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="/api/files/download/${file.id}">${file.originalName}</a>`;
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = '삭제';
                    deleteButton.onclick = () => deleteFile(file.id);
                    li.appendChild(deleteButton);
                    fileList.appendChild(li);
                });
            });
    }

    function deleteFile(fileId) {
        fetch(`/api/files/delete/${fileId}`, {
            method: 'DELETE'
        })
            .then(() => {
                alert('파일이 삭제되었습니다.');
                loadFileList();
            })
            .catch(error => {
                alert('파일 삭제 실패');
                console.error('Error:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', loadFileList);
</script>
</body>
</html>
